<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce API WebSocket Test Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .container {
            display: flex;
            gap: 20px;
        }

        .panel {
            flex: 1;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .message {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
        }

        .message.customer {
            border-left: 4px solid #007bff;
        }

        .message.admin {
            border-left: 4px solid #28a745;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>E-commerce API WebSocket Test Client</h1>

    <div class="container">
        <div class="panel">
            <h2>Customer Notifications</h2>
            <div id="customerStatus" class="status disconnected">Disconnected</div>
            <button id="connectCustomer">Connect as Customer</button>
            <button id="disconnectCustomer" disabled>Disconnect</button>
            <div id="customerMessages"></div>
        </div>

        <div class="panel">
            <h2>Admin Notifications</h2>
            <div id="adminStatus" class="status disconnected">Disconnected</div>
            <button id="connectAdmin">Connect as Admin</button>
            <button id="disconnectAdmin" disabled>Disconnect</button>
            <div id="adminMessages"></div>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <h2>Test Order Creation</h2>
        <p>Use this to test real-time notifications when orders are created or updated.</p>
        <div>
            <label>Access Token:</label>
            <input type="text" id="accessToken" placeholder="Enter your JWT access token" style="width: 300px;">
        </div>
        <div>
            <label>Shipping Address:</label>
            <input type="text" id="shippingAddress" placeholder="Enter shipping address" style="width: 300px;">
        </div>
        <button id="createOrder">Create Test Order</button>
        <div id="orderResult"></div>
    </div>

    <script>
        let customerSocket = null;
        let adminSocket = null;

        // Customer WebSocket
        document.getElementById('connectCustomer').addEventListener('click', function () {
            const customerStatus = document.getElementById('customerStatus');
            const customerMessages = document.getElementById('customerMessages');

            try {
                customerSocket = new WebSocket('ws://localhost:8000/ws/orders/');

                customerSocket.onopen = function (event) {
                    customerStatus.textContent = 'Connected';
                    customerStatus.className = 'status connected';
                    document.getElementById('connectCustomer').disabled = true;
                    document.getElementById('disconnectCustomer').disabled = false;

                    // Subscribe to order updates
                    customerSocket.send(JSON.stringify({
                        type: 'subscribe_orders'
                    }));
                };

                customerSocket.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message customer';

                    if (data.type === 'connection_established') {
                        messageDiv.textContent = `Connected: ${data.message}`;
                    } else if (data.type === 'order_update') {
                        messageDiv.innerHTML = `
                            <strong>Order Update:</strong><br>
                            Order ID: ${data.order_id}<br>
                            Status: ${data.old_status} → ${data.new_status}<br>
                            Message: ${data.message}<br>
                            Time: ${data.timestamp}
                        `;
                    } else if (data.type === 'order_created') {
                        messageDiv.innerHTML = `
                            <strong>Order Created:</strong><br>
                            Order ID: ${data.order_id}<br>
                            Message: ${data.message}<br>
                            Time: ${data.timestamp}
                        `;
                    } else {
                        messageDiv.textContent = `Message: ${JSON.stringify(data)}`;
                    }

                    customerMessages.appendChild(messageDiv);
                    customerMessages.scrollTop = customerMessages.scrollHeight;
                };

                customerSocket.onclose = function (event) {
                    customerStatus.textContent = 'Disconnected';
                    customerStatus.className = 'status disconnected';
                    document.getElementById('connectCustomer').disabled = false;
                    document.getElementById('disconnectCustomer').disabled = true;
                };

                customerSocket.onerror = function (error) {
                    console.error('Customer WebSocket error:', error);
                    customerStatus.textContent = 'Error: ' + error.message;
                    customerStatus.className = 'status disconnected';
                };

            } catch (error) {
                console.error('Failed to connect customer WebSocket:', error);
                customerStatus.textContent = 'Connection failed: ' + error.message;
            }
        });

        document.getElementById('disconnectCustomer').addEventListener('click', function () {
            if (customerSocket) {
                customerSocket.close();
                customerSocket = null;
            }
        });

        // Admin WebSocket
        document.getElementById('connectAdmin').addEventListener('click', function () {
            const adminStatus = document.getElementById('adminStatus');
            const adminMessages = document.getElementById('adminMessages');

            try {
                adminSocket = new WebSocket('ws://localhost:8000/ws/admin/orders/');

                adminSocket.onopen = function (event) {
                    adminStatus.textContent = 'Connected';
                    adminStatus.className = 'status connected';
                    document.getElementById('connectAdmin').disabled = true;
                    document.getElementById('disconnectAdmin').disabled = false;
                };

                adminSocket.onmessage = function (event) {
                    const data = JSON.parse(event.data);
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message admin';

                    if (data.type === 'connection_established') {
                        messageDiv.textContent = `Connected: ${data.message}`;
                    } else if (data.type === 'new_order') {
                        messageDiv.innerHTML = `
                            <strong>New Order:</strong><br>
                            Order ID: ${data.order_id}<br>
                            User: ${data.user_name} (ID: ${data.user_id})<br>
                            Total: $${data.total_price}<br>
                            Message: ${data.message}<br>
                            Time: ${data.timestamp}
                        `;
                    } else if (data.type === 'order_status_changed') {
                        messageDiv.innerHTML = `
                            <strong>Order Status Changed:</strong><br>
                            Order ID: ${data.order_id}<br>
                            User ID: ${data.user_id}<br>
                            Status: ${data.old_status} → ${data.new_status}<br>
                            Message: ${data.message}<br>
                            Time: ${data.timestamp}
                        `;
                    } else {
                        messageDiv.textContent = `Message: ${JSON.stringify(data)}`;
                    }

                    adminMessages.appendChild(messageDiv);
                    adminMessages.scrollTop = adminMessages.scrollHeight;
                };

                adminSocket.onclose = function (event) {
                    adminStatus.textContent = 'Disconnected';
                    adminStatus.className = 'status disconnected';
                    document.getElementById('connectAdmin').disabled = false;
                    document.getElementById('disconnectAdmin').disabled = true;
                };

                adminSocket.onerror = function (error) {
                    console.error('Admin WebSocket error:', error);
                    adminStatus.textContent = 'Error: ' + error.message;
                    adminStatus.className = 'status disconnected';
                };

            } catch (error) {
                console.error('Failed to connect admin WebSocket:', error);
                adminStatus.textContent = 'Connection failed: ' + error.message;
            }
        });

        document.getElementById('disconnectAdmin').addEventListener('click', function () {
            if (adminSocket) {
                adminSocket.close();
                adminSocket = null;
            }
        });

        // Test order creation
        document.getElementById('createOrder').addEventListener('click', function () {
            const accessToken = document.getElementById('accessToken').value;
            const shippingAddress = document.getElementById('shippingAddress').value;
            const orderResult = document.getElementById('orderResult');

            if (!accessToken) {
                orderResult.innerHTML = '<div style="color: red;">Please enter an access token</div>';
                return;
            }

            if (!shippingAddress) {
                orderResult.innerHTML = '<div style="color: red;">Please enter a shipping address</div>';
                return;
            }

            // First, add a product to cart
            fetch('http://localhost:8000/api/cart/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify({
                    product_id: 1,  // Assuming product with ID 1 exists
                    quantity: 1
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        // Then create order
                        return fetch('http://localhost:8000/api/orders/create/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${accessToken}`
                            },
                            body: JSON.stringify({
                                shipping_address: shippingAddress
                            })
                        });
                    } else {
                        throw new Error('Failed to add product to cart: ' + JSON.stringify(data));
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        orderResult.innerHTML = `<div style="color: green;">Order created successfully! Order ID: ${data.order.id}</div>`;
                    } else {
                        orderResult.innerHTML = `<div style="color: red;">Failed to create order: ${JSON.stringify(data)}</div>`;
                    }
                })
                .catch(error => {
                    orderResult.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
                });
        });

        // Auto-connect on page load (optional)
        // document.addEventListener('DOMContentLoaded', function() {
        //     document.getElementById('connectCustomer').click();
        //     document.getElementById('connectAdmin').click();
        // });
    </script>
</body>

</html>